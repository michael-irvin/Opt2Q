

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>opt2q.noise.noise &mdash; Opt2Q 0.3.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Opt2Q
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial_refs/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../topic_guides/index.html">Topic Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_refs/index.html">Opt2Q Modules Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Opt2Q</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>opt2q.noise.noise</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for opt2q.noise.noise</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Tools for Simulating Extrinsic Noise and Experimental Conditions</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># MW Irvin -- Lopez Lab -- 2018-08-08</span>
<span class="kn">from</span> <span class="nn">opt2q.utils</span> <span class="k">import</span> <span class="n">_list_the_errors</span><span class="p">,</span> <span class="n">MissingParametersErrors</span><span class="p">,</span> <span class="n">UnsupportedSimulator</span><span class="p">,</span> <span class="n">DuplicateParameterError</span>
<span class="kn">from</span> <span class="nn">pysb.bng</span> <span class="k">import</span> <span class="n">generate_equations</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">multivariate_log_normal_fn</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">covariance</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">names_column</span><span class="o">=</span><span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulates extrinsic noise by applying random log-normal variation to a set of values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mean: :class:`pandas.DataFrame`</span>
<span class="sd">        Object names and their mean values in a DataFrame with the following columns:</span>

<span class="sd">        &#39;param&#39; (required column)</span>
<span class="sd">            The name of this column can be changed by passing an argument to this function&#39;s ``name_column`` parameter.</span>
<span class="sd">            The names or the objects.</span>
<span class="sd">        &#39;value&#39; (required column)</span>
<span class="sd">            Mean (average) value (float) of the objects</span>

<span class="sd">    covariance: :class:`pandas.DataFrame`</span>
<span class="sd">        Object names and their covariance values.</span>

<span class="sd">            Column and index names must only be the names of parameters.</span>
<span class="sd">            These names must also be present in the `param_name` column of this function&#39;s ``mean`` parameter.</span>

<span class="sd">    n: `int`</span>
<span class="sd">        number of samples from the distribution</span>

<span class="sd">    names_column: `str` (optional)</span>
<span class="sd">        name of the column in this function&#39;s ``mean`` parameter that has the names of the objects</span>
<span class="sd">        that will have noise applied to them. Defaults to &quot;param_name&quot;.</span>

<span class="sd">    atol: &#39;float` (optional)</span>
<span class="sd">        Minimum value for means and values along the diagonal. This avoids nans. Defaults to 1.0e-8.</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A :class:`pandas.DataFrame` whose columns are the object names and each row contains a sample of the objects&#39; values.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># clip zeros to prevent breaking log-norm function</span>
    <span class="n">_mean</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">names_column</span><span class="p">)</span><span class="o">.</span><span class="n">clip_lower</span><span class="p">(</span><span class="n">atol</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">_cov</span> <span class="o">=</span> <span class="n">covariance</span><span class="p">[</span><span class="n">_mean</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">_mean</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="n">_cov_diagonal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">_cov</span><span class="p">),</span> <span class="n">atol</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)],</span> <span class="n">columns</span><span class="o">=</span><span class="n">_mean</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cov_i</span> <span class="ow">in</span> <span class="n">_mean</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">_cov</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">cov_i</span><span class="p">,</span> <span class="n">cov_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_cov_diagonal</span><span class="p">[</span><span class="n">cov_i</span><span class="p">]</span>

    <span class="n">mean_t_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">_mean</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">_mean</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_mean</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">_cov</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">mean_t_mean</span><span class="p">))</span>
    <span class="c1"># mu = np.log(_mean.values[:, 0])/(np.sqrt(np.diag(_cov.values) / (np.diag(mean_t_mean))+1))</span>

    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">_cov</span> <span class="o">/</span> <span class="n">mean_t_mean</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">n</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="n">_mean</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="c1"># return pd.DataFrame(np.random.multivariate_normal(_mean.values[:,0], _cov, n), columns=_mean.index.values)</span>


<div class="viewcode-block" id="NoiseModel"><a class="viewcode-back" href="../../../module_refs/noise.html#opt2q.noise.NoiseModel">[docs]</a><span class="k">class</span> <span class="nc">NoiseModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Models extrinsic noise effects and experimental conditions as variations in the values of parameters in a PySB</span>
<span class="sd">    :class:`~pysb.core.Model`.</span>

<span class="sd">    Generates a :class:`pandas.DataFrame` of noisy and/or static values. The generated values dictate values of `PySB`</span>
<span class="sd">    :class:`~pysb.core.Model` :class:`~pysb.core.Parameter` and/or :class:`~pysb.core.ComplexPattern` (model species).</span>

<span class="sd">    The :run:`~opt2q.noise.NoiseModel.run` method returns a :class:`pandas.DataFrame` formatted for use in the Opt2Q</span>
<span class="sd">    :class:`opt2q.simulator.Simulator`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param_mean: :class:`pandas.DataFrame` (optional)</span>
<span class="sd">        Object names and their mean (values in a DataFrame with the following columns:</span>

<span class="sd">        `param` (column): `str`</span>
<span class="sd">            object name</span>
<span class="sd">        `value` (column): `float`</span>
<span class="sd">            value (or average value, when noise is applied) for the parameter</span>
<span class="sd">        `apply_noise` (column): `bool` (optional)</span>
<span class="sd">            When True, this parameter is drawn from a underlying probability distribution. False by default, unless the parameter (and experimental condition) is also mentioned in the `covariance`.</span>
<span class="sd">        `num_sims`(column): `int` (optional)</span>
<span class="sd">            Sample size of the parameters.</span>
<span class="sd">            A :attr:`default_sample_size &lt;opt2q.noise.NoiseModel.default_sample_size&gt;` of 50 is used if this</span>
<span class="sd">            column is absent and `apply_noise` is True for any parameter in the experimental condition. If `apply_noise`</span>
<span class="sd">            is False, this defaults to 1.</span>
<span class="sd">        Additional columns designate experimental conditions. (optional)</span>
<span class="sd">            These columns cannot have the following names: &#39;param_name&#39;, &#39;value&#39;, &#39;apply_noise&#39;, &#39;param_i&#39;, &#39;param_j&#39;,</span>
<span class="sd">            &#39;covariance&#39;, &#39;num_sims&#39;.</span>

<span class="sd">            .. note::</span>
<span class="sd">                Each unique row, in these additional columns, designates a different experimental condition. If no</span>
<span class="sd">                additional columns are present, a single unnamed experimental condition is provided by default.</span>

<span class="sd">    param_covariance: :class:`pandas.DataFrame` (optional)</span>
<span class="sd">        Object names and their covariance values in a DataFrame with the following columns:</span>

<span class="sd">        `param_i` (column): `str`</span>
<span class="sd">            Model object name</span>
<span class="sd">        `param_j` (column): `str`</span>
<span class="sd">            Model object name</span>
<span class="sd">        `value` (column):`float`</span>
<span class="sd">            Covariance between model objects `param_i` and `param_j`</span>
<span class="sd">        Additional columns designate experimental conditions. (optional)</span>
<span class="sd">            These columns cannot have the following names: &#39;param_name&#39;, &#39;value&#39;, &#39;apply_noise&#39;, &#39;param_i&#39;, &#39;param_j&#39;,</span>
<span class="sd">            &#39;covariance&#39;, &#39;num_sims&#39;.</span>

<span class="sd">            .. note::</span>
<span class="sd">                Each unique row, in these additional columns, designates a different experimental condition. If no</span>
<span class="sd">                additional columns are present, a single unnamed experimental condition is provided by default.</span>

<span class="sd">        **Pending code** (Todo): Currently num_sims column is not read as part of the covariance dataframe. Add that option.</span>

<span class="sd">    model: `PySB` :class:`~pysb.core.Model` (optional)</span>

<span class="sd">    options: dict, (optional)</span>
<span class="sd">        Dictionary of keyword arguments:</span>

<span class="sd">        ``noise_simulator``: Function that applies noise for the parameters. Defaults to :func:`~opt2q.noise.multivariate_log_normal_fn`</span>
<span class="sd">        ``noise_simulator_kwargs``: Dictionary of kwargs passed to the noise simulator</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    default_param_values:(dict)</span>
<span class="sd">        The dictionary of parameter names and values. Any parameters named in param_covariance must appear in param_mean. If not, they can be retrieved here.</span>

<span class="sd">    default_sample_size: (int)</span>
<span class="sd">        Class attribute dictates num of simulations of a noisy value when not specified via the ``num_sim`` column of the ``param_means`` parameter.</span>

<span class="sd">    default_coefficient_of_variation: (float)</span>
<span class="sd">        Between 0 and 1. Default coefficient of variation, used when a value has noise applied to it but a variance value is not set.</span>

<span class="sd">    supported_noise_simulators: (dict)</span>
<span class="sd">        Dictionary of supported noise simulator names and functions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">supported_noise_simulators</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;multivariate_log_norm&#39;</span><span class="p">:</span> <span class="n">multivariate_log_normal_fn</span><span class="p">}</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;param_mean&#39;</span><span class="p">:{</span><span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">},</span> <span class="s1">&#39;param_covariance&#39;</span><span class="p">:{</span><span class="s1">&#39;param_i&#39;</span><span class="p">,</span> <span class="s1">&#39;param_j&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">}}</span>
    <span class="n">other_useful_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;simulation&#39;</span><span class="p">,</span> <span class="s1">&#39;num_sims&#39;</span><span class="p">,</span> <span class="s1">&#39;apply_noise&#39;</span><span class="p">}</span>

    <span class="n">default_param_values</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Use dict to designated defaults for &#39;param&#39; and &#39;value&#39;.</span>
    <span class="n">default_sample_size</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># int only</span>
    <span class="n">default_coefficient_of_variation</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param_covariance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="c1"># input settings</span>
        <span class="n">_param_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_required_columns</span><span class="p">(</span><span class="n">param_mean</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;param_mean&#39;</span><span class="p">)</span>
        <span class="n">_param_covariance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_required_columns</span><span class="p">(</span><span class="n">param_covariance</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;param_covariance&#39;</span><span class="p">)</span>
        <span class="n">_param_mean</span><span class="p">,</span> <span class="n">_param_covariance</span><span class="p">,</span> \
            <span class="n">_exp_con_cols</span><span class="p">,</span> <span class="n">_exp_con_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_experimental_condition_cols</span><span class="p">(</span><span class="n">_param_mean</span><span class="p">,</span> <span class="n">_param_covariance</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_duplicate_rows</span><span class="p">(</span><span class="n">_param_mean</span><span class="p">,</span> <span class="n">_exp_con_cols</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;param_mean&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_duplicate_rows</span><span class="p">(</span><span class="n">_param_covariance</span><span class="p">,</span> <span class="n">_exp_con_cols</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;param_covariance&#39;</span><span class="p">)</span>

        <span class="n">_param_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_params_from_param_covariance</span><span class="p">(</span><span class="n">_param_mean</span><span class="p">,</span> <span class="n">_param_covariance</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_param_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">_param_mean</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">_param_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_missing_param_values</span><span class="p">(</span><span class="n">_param_mean</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>

        <span class="n">_param_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_apply_noise_col</span><span class="p">(</span><span class="n">_param_mean</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_exp_cols_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_num_sims_col_to_experimental_conditions_df</span><span class="p">(</span><span class="n">_param_mean</span><span class="p">,</span> <span class="n">_exp_con_df</span><span class="p">,</span> <span class="n">_exp_con_cols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exp_con_cols</span> <span class="o">=</span> <span class="n">_exp_con_cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_mean</span> <span class="o">=</span> <span class="n">_param_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_covariance</span> <span class="o">=</span> <span class="n">_param_covariance</span>

        <span class="c1"># simulator setting</span>
        <span class="n">noise_simulator</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;noise_simulator&#39;</span><span class="p">,</span> <span class="s1">&#39;multivariate_log_norm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_noise_simulator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_noise_simulator</span><span class="p">(</span><span class="n">noise_simulator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_noise_simulator_kwargs</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;noise_simulator_kwargs&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_groups</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp_cols_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Setup</span>
    <span class="k">def</span> <span class="nf">_check_required_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_df</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;param_mean&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        First check of param_mean and param_covariance. Checks that the DataFrame as the required column names.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        param_df: :class:`~pandas.DataFrame` or None</span>
<span class="sd">            param_means or param_covariance argument passed upon instantiation.</span>

<span class="sd">        var_name: str (optional)</span>
<span class="sd">            Name of the variable (:class:`~pandas.DataFrame`) who&#39;s columns need checking.</span>
<span class="sd">            Currently &#39;param_mean&#39; and &#39;param_covariance&#39; only.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        param_df: :class:`~pandas.DataFrame`</span>
<span class="sd">            Returns empty :class:`~pandas.DataFrame` if ``param_df`` is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">param_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_columns</span><span class="p">[</span><span class="n">var_name</span><span class="p">])</span><span class="o">|</span><span class="nb">set</span><span class="p">(</span><span class="n">param_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_columns</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([]):</span>  <span class="c1"># df has required cols.</span>
                <span class="k">return</span> <span class="n">param_df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">note</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; must be a pd.DataFrame with the following column names: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span> <span class="o">+</span> \
                       <span class="n">_list_the_errors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_columns</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; is not supported&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_for_duplicate_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_df</span><span class="p">,</span> <span class="n">exp_col</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;param_mean&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raises ValueError the same parameter appears in the same experiment twice</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">param_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">pertinent_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">exp_col</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_columns</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">-</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">param_df</span><span class="p">[</span><span class="n">pertinent_cols</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">param_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">DuplicateParameterError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; contains a duplicate parameter.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_experimental_condition_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_m</span><span class="p">,</span> <span class="n">param_c</span><span class="p">):</span>
        <span class="n">not_exp_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_these_columns_cannot_annotate_exp_cons</span><span class="p">()</span>
        <span class="n">mean_exp_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_m</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="n">not_exp_cols</span>
        <span class="n">cov_exp_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_c</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="n">not_exp_cols</span>

        <span class="k">if</span> <span class="n">mean_exp_cols</span> <span class="o">==</span> <span class="n">cov_exp_cols</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([]):</span>
            <span class="k">return</span> <span class="n">param_m</span><span class="p">,</span> <span class="n">param_c</span><span class="p">,</span> <span class="n">mean_exp_cols</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_experimental_conditions_to_second_df</span><span class="p">(</span><span class="n">param_m</span><span class="p">,</span> <span class="n">mean_exp_cols</span><span class="p">,</span> <span class="n">param_c</span><span class="p">,</span> <span class="n">cov_exp_cols</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_these_columns_cannot_annotate_exp_cons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return column names (set) prohibited from annotating experimental conditions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>  <span class="c1">#</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">req_cols</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_cols</span> <span class="o">|=</span> <span class="n">req_cols</span>

        <span class="k">return</span> <span class="n">_cols</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_useful_columns</span>

    <span class="k">def</span> <span class="nf">_copy_experimental_conditions_to_second_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df1</span><span class="p">,</span> <span class="n">df1_cols</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">df2_cols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copies experimental conditions columns to a dataframe that lacks experimental conditions columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_cols_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">df1_cols</span><span class="p">,</span> <span class="n">df2_cols</span><span class="p">])</span>
        <span class="n">has_cols</span> <span class="o">=</span> <span class="n">_cols_</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">exp_cols</span> <span class="o">=</span> <span class="n">_cols_</span><span class="p">[</span><span class="n">has_cols</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only one DataFrame has additional columns</span>
            <span class="n">_dfs_</span> <span class="o">=</span> <span class="p">[</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">]</span>
            <span class="n">exp_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">exp_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">df_with_cols</span><span class="p">,</span> <span class="n">df_without_cols</span> <span class="o">=</span> <span class="n">_dfs_</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">has_cols</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">True</span><span class="p">)],</span> <span class="n">_dfs_</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">has_cols</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">False</span><span class="p">)]</span>
            <span class="n">exp_cols_only_df</span> <span class="o">=</span> <span class="n">df_with_cols</span><span class="p">[</span><span class="n">exp_cols</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="n">num_unique_exp_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_cols_only_df</span><span class="p">)</span>
            <span class="n">len_df_without_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_without_cols</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">expanded_df_without_cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_without_cols</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_unique_exp_rows</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">expanded_df_without_cols</span><span class="p">[</span><span class="n">exp_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                    <span class="n">exp_cols_only_df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">len_df_without_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="n">columns</span><span class="o">=</span><span class="n">exp_cols</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">expanded_df_without_cols</span><span class="p">,</span> <span class="n">df_with_cols</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_cols_</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">([])]</span>
                             <span class="o">+</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">exp_cols</span><span class="p">),</span> <span class="n">exp_cols_only_df</span><span class="p">])</span>

            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>   <span class="c1"># breaks when df_with_out_columns is of len 0.</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">exp_cols</span><span class="p">)</span><span class="o">|</span><span class="nb">set</span><span class="p">(</span><span class="n">df_without_cols</span><span class="o">.</span><span class="n">columns</span><span class="p">))),</span> <span class="n">df_with_cols</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_cols_</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">([])]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">exp_cols</span><span class="p">),</span> <span class="n">exp_cols_only_df</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_experimental_conditions</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df1_cols</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">df2_cols</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_combine_experimental_conditions</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df1_cols</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">df2_cols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combines the experimental conditions DataFrames of df1 and df2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">df1_cols</span> <span class="o">==</span> <span class="n">df2_cols</span><span class="p">:</span>
            <span class="n">exp_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df1_cols</span><span class="p">)</span>
            <span class="n">df1_exp_idx</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">exp_cols</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="n">df2_exp_idx</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">exp_cols</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="n">combined_exp_idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df1_exp_idx</span><span class="p">,</span> <span class="n">df2_exp_idx</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">exp_cols</span><span class="p">),</span> <span class="n">combined_exp_idx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Means and Covariances use the same columns to index experiments&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_combine_param_i_j</span><span class="p">(</span><span class="n">param_c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combines the param_i and param_j columns. This is useful for adding params mentioned in param_covariance to</span>
<span class="sd">        param_mean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param_c_i</span> <span class="o">=</span> <span class="n">param_c</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;param_i&#39;</span><span class="p">:</span> <span class="s1">&#39;param&#39;</span><span class="p">},</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;param_j&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">])</span>
        <span class="n">param_c_j</span> <span class="o">=</span> <span class="n">param_c</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;param_j&#39;</span><span class="p">:</span> <span class="s1">&#39;param&#39;</span><span class="p">},</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;param_i&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">param_c_i</span><span class="p">,</span> <span class="n">param_c_j</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_apply_noise_col</span><span class="p">(</span><span class="n">_df</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_df</span><span class="p">[</span><span class="s1">&#39;apply_noise&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">_df</span><span class="p">[</span><span class="s1">&#39;apply_noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_value</span>
        <span class="k">return</span> <span class="n">_df</span>

    <span class="k">def</span> <span class="nf">_add_params_from_param_covariance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_m</span><span class="p">,</span> <span class="n">param_c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Any parameters mentioned in ``param_covariance`` must also appear in ``param_mean``.  This adds the parameter</span>
<span class="sd">        names overwrites the ``apply_noise`` column for with to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">param_c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param_m</span>

        <span class="k">if</span> <span class="n">param_m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_param_m</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">param_m</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">|</span><span class="p">{</span><span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">}))</span>  <span class="c1"># make it possible to merge</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_param_m</span> <span class="o">=</span> <span class="n">param_m</span>

        <span class="n">params_from_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_param_i_j</span><span class="p">(</span><span class="n">param_c</span><span class="p">)</span>
        <span class="n">params_from_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_apply_noise_col</span><span class="p">(</span><span class="n">params_from_c</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">added_params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">params_from_c</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;apply_noise&#39;</span><span class="p">]),</span> <span class="n">_param_m</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">params_from_c</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">added_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_missing_param_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If parameters appear in &#39;param_covariance&#39; but are absent in &#39;param_mean&#39;, try to fill them in with parameter</span>
<span class="sd">        values from the model.</span>

<span class="sd">        Creates/Updates: self.default_param_values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_param_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mean</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mean</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_param_values</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_param_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_parameters_from_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">mean</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mean</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_param_values</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">mean</span><span class="p">[[</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">MissingParametersErrors</span><span class="p">(</span><span class="s2">&quot;&#39;param_covariance&#39; contains parameters that are absent from &#39;param_mean&#39;.&quot;</span>
                                          <span class="s2">&quot; Please add these parameters to &#39;param_mean&#39; or include a PySB model&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mean</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_parameters_from_model</span><span class="p">(</span><span class="n">_model</span><span class="p">):</span>
        <span class="n">generate_equations</span><span class="p">(</span><span class="n">_model</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_add_num_sims_col_to_experimental_conditions_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_mean</span><span class="p">,</span> <span class="n">exp_con_df</span><span class="p">,</span> <span class="n">exp_con_cols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds num_sims column (i.e. sample size) to the dataframe. If not already there.</span>

<span class="sd">        Group by experimental conditions then apply num_sims, as either max of the ``num_sims`` or default for if</span>
<span class="sd">        ``apply_noise`` is True or Not.</span>

<span class="sd">        Requires an ``apply_noise`` column which is added (if not already present by self._add_apply_noise_col).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        param_mean: :class:`~pandas.DataFrame`</span>

<span class="sd">            - Must have column named ``apply_noise``.</span>
<span class="sd">            - The columns annotating the experimental conditions must be the same as exp_con_df.columns.</span>
<span class="sd">            - There should be the same number of unique e experimental conditions rows as there are rows in exp_con_df</span>

<span class="sd">        exp_con_df: :class:`~pandas.DataFrame`</span>
<span class="sd">            The experimental conditions in the measurement.</span>
<span class="sd">            Must be the same length as the number of unique experimental conditions rows in exp_con_df param_mean</span>
<span class="sd">            Or pd.DataFrame() (if exp_con_cols is an empty set)</span>
<span class="sd">            This is created by self._check_experimental_condition_cols</span>

<span class="sd">        exp_con_cols: set</span>
<span class="sd">            The columns designating experimental conditions. This is created by self._check_experimental_condition_cols</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">param_mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;num_sims&#39;</span> <span class="ow">in</span> <span class="n">param_mean</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_con_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">param_num_sims</span> <span class="o">=</span> <span class="n">param_mean</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">exp_con_cols</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_num_sims_as_max</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_num_sims_w_ec</span><span class="p">(</span><span class="n">param_num_sims</span><span class="p">,</span> <span class="n">exp_con_cols</span><span class="p">,</span> <span class="n">exp_con_df</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_num_sims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_num_sims_as_max</span><span class="p">(</span><span class="n">param_mean</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_con_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">param_num_sims</span> <span class="o">=</span> <span class="n">param_mean</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">exp_con_cols</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_num_sims_as_default</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_num_sims_w_ec</span><span class="p">(</span><span class="n">param_num_sims</span><span class="p">,</span> <span class="n">exp_con_cols</span><span class="p">,</span> <span class="n">exp_con_df</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_num_sims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_num_sims_as_default</span><span class="p">(</span><span class="n">param_mean</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">param_num_sims</span><span class="p">[[</span><span class="s1">&#39;num_sims&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_set_num_sims_as_max</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
        <span class="n">group</span><span class="p">[</span><span class="s1">&#39;num_sims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;num_sims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">group</span>

    <span class="k">def</span> <span class="nf">_set_num_sims_as_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define the ``num_sims`` of the ``param_mean`` :class:`~pandas.DataFrame` or group as the default based on if</span>
<span class="sd">        ``apply_noise`` is True or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group</span><span class="p">[</span><span class="s1">&#39;num_sims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_sample_size</span><span class="p">][</span><span class="n">group</span><span class="o">.</span><span class="n">apply_noise</span><span class="o">.</span><span class="n">any</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">group</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_merge_num_sims_w_ec</span><span class="p">(</span><span class="n">params_num_sims</span> <span class="p">,</span> <span class="n">exp_con_cols</span><span class="p">,</span> <span class="n">exp_con_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">):</span>
        <span class="n">exp_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="s1">&#39;num_sims&#39;</span><span class="p">}</span> <span class="o">|</span> <span class="n">exp_con_cols</span><span class="p">)</span>
        <span class="n">num_sims</span> <span class="o">=</span> <span class="n">params_num_sims</span><span class="p">[</span><span class="n">exp_cols</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">exp_con_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">num_sims</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">how</span><span class="p">)</span>

    <span class="c1"># Methods used by the calibrator.objective_function</span>
<div class="viewcode-block" id="NoiseModel.update_values"><a class="viewcode-back" href="../../../module_refs/noise.html#opt2q.noise.NoiseModel.update_values">[docs]</a>    <span class="k">def</span> <span class="nf">update_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param_covariance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replaces rows of the DataFrame</span>

<span class="sd">        .. note:: Updates cannot introduce new values in the &#39;param&#39; and experimental conditions columns.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from opt2q.noise import NoiseModel</span>
<span class="sd">        &gt;&gt;&gt; mean_values = pd.DataFrame([[&#39;A&#39;, 1.0, &#39;KO&#39;], [&#39;B&#39;, 1.0, &#39;WT&#39;], [&#39;A&#39;, 1.0, &#39;WT&#39;]],</span>
<span class="sd">        ...                            columns=[&#39;param&#39;, &#39;value&#39;, &#39;ec&#39;])</span>
<span class="sd">        &gt;&gt;&gt; noise_model = NoiseModel(param_mean=mean_values)</span>
<span class="sd">        &gt;&gt;&gt; noise_model.update_values(param_mean=pd.DataFrame([[&#39;A&#39;, 2]], columns=[&#39;param&#39;, &#39;value&#39;]))</span>
<span class="sd">        &gt;&gt;&gt; print(noise_model.param_mean)</span>
<span class="sd">            param   value   &#39;ec&#39;</span>
<span class="sd">        0   &#39;A&#39;     2.0     &#39;KO&#39;</span>
<span class="sd">        1   &#39;A&#39;     2.0     &#39;WT&#39;</span>
<span class="sd">        2   &#39;B&#39;     1.0     &#39;WT&#39;</span>

<span class="sd">        Notice how the DataFrame in update_values does not mention &#39;ec&#39;. In this case *all* &#39;A&#39; take the updated value.</span>

<span class="sd">        &gt;&gt;&gt; from opt2q.noise import NoiseModel</span>
<span class="sd">        &gt;&gt;&gt; mean_values = pd.DataFrame([[&#39;A&#39;, 1.0, &#39;KO&#39;], [&#39;B&#39;, 1.0, &#39;WT&#39;], [&#39;A&#39;, 1.0, &#39;WT&#39;]],</span>
<span class="sd">        ...                            columns=[&#39;param&#39;, &#39;value&#39;, &#39;ec&#39;])</span>
<span class="sd">        &gt;&gt;&gt; noise_model = NoiseModel(param_mean=mean_values)</span>
<span class="sd">        &gt;&gt;&gt; noise_model.update_values(param_mean=pd.DataFrame([[&#39;KO&#39;, 2]], columns=[&#39;ec&#39;, &#39;num_sims&#39;]))</span>
<span class="sd">        &gt;&gt;&gt; print(noise_model.param_mean)</span>
<span class="sd">            param   value   ec      num_sims</span>
<span class="sd">        0   &#39;A&#39;     2.0     &#39;KO&#39;    2</span>
<span class="sd">        1   &#39;A&#39;     2.0     &#39;WT&#39;    1</span>
<span class="sd">        2   &#39;B&#39;     1.0     &#39;WT&#39;    1</span>

<span class="sd">        &gt;&gt;&gt; print(noise_model._exp_con_cols)</span>
<span class="sd">            ec      num_sims</span>
<span class="sd">        0   &#39;KO&#39;    2</span>
<span class="sd">        1   &#39;WT&#39;    1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">param_mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">updated_param_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_param_mean</span><span class="p">(</span><span class="n">param_mean</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;num_sims&#39;</span> <span class="ow">in</span> <span class="n">updated_param_mean</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">_exp_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_exp_con_df</span><span class="p">(</span><span class="n">updated_param_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exp_con_cols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exp_cols_df</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;num_sims&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_mean</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">updated_param_mean</span> <span class="o">=</span> <span class="n">updated_param_mean</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;num_sims&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_updated_df</span><span class="p">(</span><span class="n">updated_param_mean</span><span class="p">,</span> <span class="s2">&quot;param_mean&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_param_mean</span> <span class="o">=</span> <span class="n">updated_param_mean</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exp_cols_df</span> <span class="o">=</span> <span class="n">_exp_cols</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_updated_df</span><span class="p">(</span><span class="n">updated_param_mean</span><span class="p">,</span> <span class="s2">&quot;param_mean&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_param_mean</span> <span class="o">=</span> <span class="n">updated_param_mean</span>

        <span class="k">if</span> <span class="n">param_covariance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">updated_param_covariance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_param_covariance</span><span class="p">(</span><span class="n">param_covariance</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_updated_df</span><span class="p">(</span><span class="n">updated_param_covariance</span><span class="p">,</span> <span class="s2">&quot;param_covariance&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># Try switching the param axes</span>
                <span class="n">param_covariance</span> <span class="o">=</span> <span class="n">param_covariance</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;param_i&#39;</span><span class="p">:</span><span class="s1">&#39;param_j&#39;</span><span class="p">,</span> <span class="s1">&#39;param_j&#39;</span><span class="p">:</span><span class="s1">&#39;param_i&#39;</span><span class="p">})</span>
                <span class="n">updated_param_covariance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_param_covariance</span><span class="p">(</span><span class="n">param_covariance</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_updated_df</span><span class="p">(</span><span class="n">updated_param_covariance</span><span class="p">,</span> <span class="s2">&quot;param_covariance&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param_covariance</span> <span class="o">=</span> <span class="n">updated_param_covariance</span></div>

    <span class="k">def</span> <span class="nf">_update_param_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_mean</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the param_mean DataFrame with values from a similarly shaped column (i.e. same columns). This method is</span>
<span class="sd">        intended for the :class:`~opt2q.calibrator.ObjectiveFunction`, primarily.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_for_update</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp_con_cols</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;param&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">param_mean</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
        <span class="n">old_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_mean</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_for_update</span><span class="p">)</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="n">param_mean</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_for_update</span><span class="p">)</span>
        <span class="n">new_means</span> <span class="o">=</span> <span class="n">updates</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">old_means</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">new_means</span><span class="p">[</span><span class="s1">&#39;apply_noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_means</span><span class="p">[</span><span class="s1">&#39;apply_noise&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_means</span>

    <span class="k">def</span> <span class="nf">_update_param_covariance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_covariance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the param_mean DataFrame with values from a similarly shaped column (i.e. same columns). This method is</span>
<span class="sd">        intended for the :class:`~opt2q.calibrator.ObjectiveFunction`, primarily.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_for_update</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp_con_cols</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;param_i&#39;</span><span class="p">,</span> <span class="s1">&#39;param_j&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">param_covariance</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
        <span class="n">old_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_covariance</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_for_update</span><span class="p">)</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="n">param_covariance</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_for_update</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updates</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">old_cov</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_exp_con_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_mean</span><span class="p">,</span> <span class="n">exp_con_cols</span><span class="p">,</span> <span class="n">exp_con_df</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_con_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">param_num_sims</span> <span class="o">=</span> <span class="n">param_mean</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">exp_con_cols</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_num_sims_as_max</span><span class="p">)</span>
            <span class="n">old_exp_cons</span> <span class="o">=</span> <span class="n">exp_con_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">exp_con_cols</span><span class="p">))</span>
            <span class="n">new_exp_cons</span> <span class="o">=</span> <span class="n">param_num_sims</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">exp_con_cols</span><span class="o">|</span><span class="p">{</span><span class="s1">&#39;num_sims&#39;</span><span class="p">})]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">exp_con_cols</span><span class="p">))</span>
            <span class="n">new_exp_cons</span> <span class="o">=</span> <span class="n">new_exp_cons</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">old_exp_cons</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="n">new_exp_cons</span><span class="p">[</span><span class="s1">&#39;num_sims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_exp_cons</span><span class="p">[</span><span class="s1">&#39;num_sims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_exp_cons</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param_num_sims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_num_sims_as_max</span><span class="p">(</span><span class="n">param_mean</span><span class="p">)[[</span><span class="s1">&#39;num_sims&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">param_num_sims</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_updated_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Your update includes experimental conditions and &#39;param&#39; not present in &#39;param_mean&#39;.&quot;</span>
                             <span class="s2">&quot;Updates to &#39;params&#39; and experimental conditions columns are forbidden.&quot;</span><span class="p">)</span>

    <span class="c1"># Accessing Attributes from the Outside</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_mean</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_covariance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_covariance</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">experimental_conditions_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exp_cols_df</span>

    <span class="c1"># Run Method and Assoc.</span>
    <span class="k">def</span> <span class="nf">_check_noise_simulator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_simulator_name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_noise_simulators</span><span class="p">[</span><span class="n">_simulator_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnsupportedSimulator</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a supported noise simulator&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_simulator_name</span><span class="p">))</span>

<div class="viewcode-block" id="NoiseModel.run"><a class="viewcode-back" href="../../../module_refs/noise.html#opt2q.noise.NoiseModel.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a :class:`pandas.DataFrame` of noisy and/or static values of PySB` :class:`~pysb.core.Model`,</span>
<span class="sd">        :class:`~pysb.core.Parameter` and/or :class:`~pysb.core.ComplexPattern` (model species).</span>

<span class="sd">        This serves as an input to the :class:`~opt2q.simulator.Simulator`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simulated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_covariance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">experimental_conditions_dataframe</span><span class="p">)</span>
        <span class="n">simulated</span> <span class="o">=</span> <span class="n">simulated</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;simulation&#39;</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">simulated</span></div>

    <span class="k">def</span> <span class="nf">_simulate_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">exp</span><span class="p">):</span>
        <span class="n">simulated</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">exp_id</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">mean_i</span> <span class="o">=</span> <span class="n">mean</span>
            <span class="n">cov_i</span> <span class="o">=</span> <span class="n">cov</span>

            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exp_con_cols</span><span class="p">:</span>
                <span class="n">mean_conditional</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="n">cov_conditional</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="n">mean_i</span> <span class="o">=</span> <span class="n">mean_i</span><span class="p">[</span><span class="n">mean_conditional</span><span class="p">]</span>
                <span class="n">cov_i</span> <span class="o">=</span> <span class="n">cov_i</span><span class="p">[</span><span class="n">cov_conditional</span><span class="p">]</span>

            <span class="n">sim_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulate</span><span class="p">(</span><span class="n">mean_i</span><span class="p">,</span> <span class="n">cov_i</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">)</span>
            <span class="n">simulated</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">simulated</span><span class="p">,</span> <span class="n">sim_i</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">simulated</span>

    <span class="k">def</span> <span class="nf">_simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">exp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a DataFrame of parameter values formatted for use in the Opt2Q simulator.</span>

<span class="sd">        The column names are taken from `param` and the experimental conditions columns.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mean: :class:`~pandas.DataFrame`</span>
<span class="sd">            Mean param values. This class&#39;s :attr:`~opt2q.noise.NoiseModel.param_means` attribute or a group thereof.</span>
<span class="sd">        cov: :class:`~pandas.DataFrame`</span>
<span class="sd">            Param covariance values. This class&#39;s :attr:`~opt2q.noise.NoiseModel.param_covariance` attribute or a group</span>
<span class="sd">            thereof.</span>
<span class="sd">        exp: :class:`~pandas.DataFrame`</span>
<span class="sd">            Experimental Conditions index This class&#39;s :attr:`~opt2q.noise.NoiseModel.param_covariance` attribute or a</span>
<span class="sd">            group thereof.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp_con_cols</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fixed_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_fixed_values</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
            <span class="n">noisy_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_noisy_values</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
            <span class="n">exp_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_exp_idx</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

            <span class="n">simulated</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="n">simulated</span><span class="p">[</span><span class="n">fixed_params</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_params</span>
            <span class="n">simulated</span><span class="p">[</span><span class="n">noisy_params</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">noisy_params</span>
            <span class="n">simulated</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp_con_cols</span><span class="p">)]</span> <span class="o">=</span> <span class="n">exp_indices</span>
            <span class="k">return</span> <span class="n">simulated</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_fixed_values</span><span class="p">(</span><span class="n">_mean</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">names_col</span><span class="o">=</span><span class="s1">&#39;param&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Repeats the values in ``_mean`` for which &#39;apply_noise&#39; is False. The column is the param name.</span>

<span class="sd">        .. note:: returns an index named &#39;param&#39;. This is resolved by the method that calls this method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        _mean: :class:`~pandas.DataFrame`</span>
<span class="sd">            Mean param values. This class&#39;s :attr:`~opt2q.noise.NoiseModel.param_means` attribute or a group thereof.</span>
<span class="sd">        exp: :class:`~pandas.DataFrame`</span>
<span class="sd">            Experimental Conditions index This class&#39;s :attr:`~opt2q.noise.NoiseModel.param_covariance` attribute or a</span>
<span class="sd">            group thereof.</span>
<span class="sd">        names_col: (str), optional</span>
<span class="sd">            Defaults to &#39;param&#39;. This will become useful when Opt2Q supports PySB model components (e.g. initials).</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        :class:`~pandas.DataFrame`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;num_sims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">fixed_terms</span> <span class="o">=</span> <span class="n">_mean</span><span class="p">[</span><span class="n">_mean</span><span class="p">[</span><span class="s1">&#39;apply_noise&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
        <span class="n">fixed_terms</span> <span class="o">=</span> <span class="n">fixed_terms</span><span class="p">[[</span><span class="n">names_col</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">names_col</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">fixed_terms</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">fixed_terms</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">fixed_terms</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fixed_terms</span>

    <span class="k">def</span> <span class="nf">_add_noisy_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_mean</span><span class="p">,</span> <span class="n">_cov</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">names_col</span><span class="o">=</span><span class="s1">&#39;param&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies noise to parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        _mean: :class:`~pandas.DataFrame`</span>
<span class="sd">            Mean param values. This class&#39;s :attr:`~opt2q.noise.NoiseModel.param_means` attribute or a group thereof.</span>

<span class="sd">        .. note::</span>

<span class="sd">            It is essential that _mean includes parameters mentioned in _cov. The</span>
<span class="sd">            :class:`~opt2q.noise.NoiseModel._add_params_from_param_covariance` method makes sure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;num_sims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">varied_terms</span> <span class="o">=</span> <span class="n">_mean</span><span class="p">[</span><span class="n">_mean</span><span class="p">[</span><span class="s1">&#39;apply_noise&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">varied_terms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">cov_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_covariance_matrix</span><span class="p">(</span><span class="n">varied_terms</span><span class="p">,</span> <span class="n">_cov</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noise_simulator</span><span class="p">(</span><span class="n">varied_terms</span><span class="p">[[</span><span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]],</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">names_column</span><span class="o">=</span><span class="n">names_col</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_noise_simulator_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_means</span><span class="p">,</span> <span class="n">_covariances</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns :class:`~pandas.DataFrame` covariance matrix the columns and indices are the parameter names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params_array</span> <span class="o">=</span> <span class="n">_means</span><span class="p">[[</span><span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">len_cov_mat</span> <span class="o">=</span> <span class="n">params_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cov_mat_diagonal</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">params_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_coefficient_of_variation</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># square matrix of NaNs length of dict_means</span>
        <span class="n">raw_covariance_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">len_cov_mat</span><span class="p">,</span> <span class="n">len_cov_mat</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">raw_covariance_matrix</span><span class="p">,</span> <span class="n">cov_mat_diagonal</span><span class="p">)</span>
        <span class="n">incomplete_cov_mat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">raw_covariance_matrix</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">params_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">params_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">complete_covariance_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_covariance_matrix</span><span class="p">(</span><span class="n">params_array</span><span class="p">,</span> <span class="n">_covariances</span><span class="p">,</span> <span class="n">incomplete_cov_mat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">complete_covariance_mat</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_update_covariance_matrix</span><span class="p">(</span><span class="n">_mean_params_array</span><span class="p">,</span> <span class="n">covariances_df</span><span class="p">,</span> <span class="n">incomplete_covariance_matrix</span><span class="p">):</span>
        <span class="c1"># Covariance updates</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">covariance_updates</span> <span class="o">=</span> <span class="n">covariances_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;param_i&#39;</span><span class="p">,</span> <span class="s1">&#39;param_j&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
            <span class="n">covariance_updates</span> <span class="o">=</span> <span class="n">covariance_updates</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">_mean_params_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                                                            <span class="n">columns</span><span class="o">=</span><span class="n">_mean_params_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">covariance_updates</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">covariance_updates</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>  <span class="c1"># Todo: Make sure p_i, p_j == p_j, p_i</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">covariance_updates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Complete the covariance matrix here.</span>
        <span class="n">incomplete_covariance_matrix</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">covariance_updates</span><span class="p">)</span>
        <span class="n">complete_covariance_matrix</span> <span class="o">=</span> <span class="n">incomplete_covariance_matrix</span>
        <span class="k">return</span> <span class="n">complete_covariance_matrix</span>

    <span class="k">def</span> <span class="nf">_apply_exp_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">):</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp_con_cols</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;num_sims&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Michael W Irvin.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.3.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>